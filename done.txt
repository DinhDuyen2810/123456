create table users (
  id uuid primary key default gen_random_uuid(),
  public_key text not null,
  encrypted_private_key text not null,
  salt text not null,
  created_at timestamp default now()
);
create table files (
  file_id uuid primary key default gen_random_uuid(),
  owner_id uuid references users(id),
  storage_path text not null,
  encrypted_file_key_owner text not null,
  created_at timestamp default now()
);
create table file_shares (
  id uuid primary key default gen_random_uuid(),
  file_id uuid references files(file_id),
  shared_with_user_id uuid references users(id),
  encrypted_file_key text not null,
  created_at timestamp default now()
);

alter table users enable row level security;
alter table files enable row level security;
alter table file_shares enable row level security;

create policy "Allow all for demo"
on users for all
using (true);
create policy "Allow all for demo"
on files for all
using (true);
create policy "Allow all for demo"
on file_shares for all
using (true);

alter table files
add column original_filename text,
add column mime_type text;

create policy "Allow read encrypted files"
on storage.objects
for select
using (bucket_id = 'encrypted-files');

create policy "Allow upload encrypted files"
on storage.objects
for insert
with check (bucket_id = 'encrypted-files');

